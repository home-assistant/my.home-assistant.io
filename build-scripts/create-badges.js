const path = require("path");
const fs = require("fs");
const redirects = require("../redirect.json");
const { optimize } = require("svgo");
const TextToSVG = require('text-to-svg');

const OUTPUT_DIR = path.resolve(__dirname, "../public/badges");

function escapeXml(s) {
  if (s === undefined || typeof s !== "string") {
    return undefined;
  } else {
    return s
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&apos;");
  }
}

function createAccessibleText(message) {
  return message + " My Home Assistant";
}

function renderAriaAttributes({ accessibleText }) {
  return `role="img" aria-label="${escapeXml(accessibleText)}"`;
}

function renderTitle({ accessibleText }) {
  return `<title>${escapeXml(accessibleText)}</title>`;
}

function renderBadge({ width, height, accessibleText }, main) {
  return `
  <svg 
    xmlns="http://www.w3.org/2000/svg"
    xmlns:xlink="http://www.w3.org/1999/xlink"
    width="${width / 2}"
    height="${height / 2}"
    viewBox="0 0 ${width} ${height}"
    ${renderAriaAttributes({ accessibleText })}
    style="border-radius:24px"
  >
  ${renderTitle({ accessibleText })}
  <rect width="${width}" height="${height}" rx="48" fill="#18BCF2"/>
      <path d="M49.7062 36.3438C51.8833 36.3438 53.6854 36.875 55.1125 37.9375C56.5396 38.9896 57.4146 40.4115 57.7375 42.2031L53.6125 43.2969C53.4146 42.349 52.9614 41.625 52.2531 41.125C51.5552 40.625 50.6646 40.375 49.5812 40.375C48.4667 40.375 47.5812 40.6406 46.925 41.1719C46.2687 41.7031 45.9406 42.401 45.9406 43.2656C45.9406 44.6302 46.8156 45.5365 48.5656 45.9844L52.3312 46.9375C54.3521 47.4583 55.8573 48.2865 56.8469 49.4219C57.8469 50.5469 58.3469 51.9271 58.3469 53.5625C58.3469 55.6875 57.576 57.4062 56.0344 58.7188C54.4927 60.0208 52.4406 60.6719 49.8781 60.6719C47.4823 60.6719 45.5083 60.1146 43.9562 59C42.3833 57.8646 41.4562 56.3802 41.175 54.5469L45.3 53.4688C45.4354 54.4688 45.925 55.2448 46.7687 55.7969C47.6125 56.3385 48.6906 56.6094 50.0031 56.6094C51.2635 56.6094 52.2375 56.3646 52.925 55.875C53.6229 55.3854 53.9719 54.6979 53.9719 53.8125C53.9719 52.4375 53.1177 51.5208 51.4094 51.0625L47.5969 50.1719C45.5969 49.6719 44.0917 48.8385 43.0812 47.6719C42.0812 46.4948 41.5812 45.0781 41.5812 43.4219C41.5812 41.3281 42.326 39.625 43.8156 38.3125C45.3156 37 47.2792 36.3438 49.7062 36.3438ZM63.5875 36.7969H67.9625V46.4219L77.7594 46.4531V36.7969H82.1812V60.25H77.7594V50.3594L67.9625 50.2969V60.25H63.5875V36.7969ZM98.8281 36.375C101.036 36.3438 103.016 36.8594 104.766 37.9219C106.526 38.974 107.885 40.4271 108.844 42.2812C109.802 44.1354 110.271 46.2083 110.25 48.5C110.271 50.7917 109.797 52.8698 108.828 54.7344C107.87 56.5885 106.51 58.0469 104.75 59.1094C102.99 60.1615 101.005 60.6719 98.7969 60.6406C96.5781 60.6406 94.6042 60.125 92.875 59.0938C91.1458 58.0521 89.8073 56.6094 88.8594 54.7656C87.9114 52.9219 87.4375 50.8333 87.4375 48.5C87.4167 46.7917 87.6875 45.1823 88.25 43.6719C88.8125 42.1615 89.5885 40.8698 90.5781 39.7969C91.5781 38.7135 92.7917 37.8698 94.2187 37.2656C95.6458 36.651 97.1823 36.3542 98.8281 36.375ZM98.8594 56.375C100.922 56.375 102.568 55.6667 103.797 54.25C105.026 52.8229 105.641 50.9062 105.641 48.5C105.641 46.0729 105.031 44.151 103.812 42.7344C102.604 41.3177 100.953 40.6094 98.8594 40.6094C96.7656 40.6094 95.1042 41.3177 93.875 42.7344C92.6562 44.151 92.0469 46.0729 92.0469 48.5C92.0469 50.9271 92.6562 52.849 93.875 54.2656C95.0937 55.6719 96.7552 56.375 98.8594 56.375ZM144.928 36.7969L137.803 60.25H133.537L128.741 44.5625L123.787 60.25H119.522L112.491 36.7969H117.287L121.694 52.7031L126.334 36.7969H131.178L135.678 52.7656L140.256 36.7969H144.928ZM172.253 54.9375H163.769L161.909 60.25H157.362L165.816 36.7969H170.112H170.237L178.675 60.25H174.034L172.253 54.9375ZM170.972 51.2969L168.019 42.7188L165.05 51.2969H170.972ZM200.947 60.25H196.009L192.275 51.5781H187.525V60.25H183.15V36.7969H192.197C194.999 36.7969 197.129 37.4323 198.587 38.7031C200.046 39.9635 200.775 41.7917 200.775 44.1875C200.775 45.8125 200.421 47.1979 199.712 48.3438C199.015 49.4792 198.004 50.3125 196.681 50.8438L200.947 60.25ZM196.166 44.1875C196.166 43.0938 195.827 42.2344 195.15 41.6094C194.483 40.9844 193.499 40.6719 192.197 40.6719H187.525V47.7344H192.166C193.489 47.7344 194.483 47.4219 195.15 46.7969C195.827 46.1615 196.166 45.2917 196.166 44.1875ZM221.031 56.1562V60.25H206.344V36.7969H221V40.9219H210.719V46.4531H219.906V50.3281H210.719V56.1562H221.031ZM239.647 54.9375H231.162L229.303 60.25H224.756L233.209 36.7969H237.506H237.631L246.069 60.25H241.428L239.647 54.9375ZM238.366 51.2969L235.412 42.7188L232.444 51.2969H238.366ZM257.575 36.3438C259.752 36.3438 261.554 36.875 262.981 37.9375C264.408 38.9896 265.283 40.4115 265.606 42.2031L261.481 43.2969C261.283 42.349 260.83 41.625 260.122 41.125C259.424 40.625 258.533 40.375 257.45 40.375C256.335 40.375 255.45 40.6406 254.794 41.1719C254.137 41.7031 253.809 42.401 253.809 43.2656C253.809 44.6302 254.684 45.5365 256.434 45.9844L260.2 46.9375C262.221 47.4583 263.726 48.2865 264.716 49.4219C265.716 50.5469 266.216 51.9271 266.216 53.5625C266.216 55.6875 265.445 57.4062 263.903 58.7188C262.361 60.0208 260.309 60.6719 257.747 60.6719C255.351 60.6719 253.377 60.1146 251.825 59C250.252 57.8646 249.325 56.3802 249.044 54.5469L253.169 53.4688C253.304 54.4688 253.794 55.2448 254.637 55.7969C255.481 56.3385 256.559 56.6094 257.872 56.6094C259.132 56.6094 260.106 56.3646 260.794 55.875C261.492 55.3854 261.841 54.6979 261.841 53.8125C261.841 52.4375 260.986 51.5208 259.278 51.0625L255.466 50.1719C253.466 49.6719 251.96 48.8385 250.95 47.6719C249.95 46.4948 249.45 45.0781 249.45 43.4219C249.45 41.3281 250.195 39.625 251.684 38.3125C253.184 37 255.148 36.3438 257.575 36.3438ZM291.572 36.375C293.78 36.3438 295.759 36.8594 297.509 37.9219C299.27 38.974 300.629 40.4271 301.587 42.2812C302.546 44.1354 303.015 46.2083 302.994 48.5C303.015 50.7917 302.541 52.8698 301.572 54.7344C300.614 56.5885 299.254 58.0469 297.494 59.1094C295.733 60.1615 293.749 60.6719 291.541 60.6406C289.322 60.6406 287.348 60.125 285.619 59.0938C283.89 58.0521 282.551 56.6094 281.603 54.7656C280.655 52.9219 280.181 50.8333 280.181 48.5C280.16 46.7917 280.431 45.1823 280.994 43.6719C281.556 42.1615 282.332 40.8698 283.322 39.7969C284.322 38.7135 285.535 37.8698 286.962 37.2656C288.39 36.651 289.926 36.3542 291.572 36.375ZM291.603 56.375C293.666 56.375 295.311 55.6667 296.541 54.25C297.77 52.8229 298.384 50.9062 298.384 48.5C298.384 46.0729 297.775 44.151 296.556 42.7344C295.348 41.3177 293.697 40.6094 291.603 40.6094C289.509 40.6094 287.848 41.3177 286.619 42.7344C285.4 44.151 284.791 46.0729 284.791 48.5C284.791 50.9271 285.4 52.849 286.619 54.2656C287.837 55.6719 289.499 56.375 291.603 56.375ZM312.625 40.8906V46.8438H321.297L321.266 50.7812H312.625V60.25H308.281V36.7969H312.625H322.938L322.906 40.8906H312.625Z" fill="white"/>
  ${main}
  <g style="transform: translate(${width - 497}px, 0);">
      <rect x="344" y="16" width="137" height="64" rx="32" fill="#F2F4F9"/>
      <path d="M394.419 37.0469V60.5H390.122V46.7969L384.716 60.5H380.559L375.216 46.9062V60.5H371.028V37.0469H375.216L382.638 55.4062L390.122 37.0469H394.419ZM403.784 37.0469L409.128 46.9375L414.472 37.0469H419.238L411.269 51.1875V60.5H406.878V51.1875L398.847 37.0469H403.784Z" fill="#18BCF2"/>
      <g>
          <path d="M457 60C457 61.65 455.65 63 454 63H430C428.35 63 427 61.65 427 60V51C427 49.35 427.95 47.05 429.12 45.88L439.88 35.12C441.05 33.95 442.96 33.95 444.12 35.12L454.88 45.88C456.05 47.05 457 49.35 457 51V60Z" fill="#18BCF2"/>
          <path d="M442 45.5C443.105 45.5 444 44.6046 444 43.5C444 42.3954 443.105 41.5 442 41.5C440.895 41.5 440 42.3954 440 43.5C440 44.6046 440.895 45.5 442 45.5Z" fill="#F2F4F9" stroke="#F2F4F9"/>
          <path d="M449.5 53.5C450.605 53.5 451.5 52.6046 451.5 51.5C451.5 50.3954 450.605 49.5 449.5 49.5C448.395 49.5 447.5 50.3954 447.5 51.5C447.5 52.6046 448.395 53.5 449.5 53.5Z" fill="#F2F4F9" stroke="#F2F4F9" stroke-miterlimit="10"/>
          <path d="M434.5 57.5C435.605 57.5 436.5 56.6046 436.5 55.5C436.5 54.3954 435.605 53.5 434.5 53.5C433.395 53.5 432.5 54.3954 432.5 55.5C432.5 56.6046 433.395 57.5 434.5 57.5Z" fill="#F2F4F9" stroke="#F2F4F9" stroke-miterlimit="10"/>
          <path d="M442 43.48V63L434.5 55.5" stroke="#F2F4F9" fill="none" stroke-width="2.25" stroke-miterlimit="10"/>
          <path d="M449.5 51.46L442.09 58.87" stroke="#F2F4F9" fill="none" stroke-width="2.25" stroke-miterlimit="10"/>
      </g>
  </g>
</svg>`;
}

function myBadge({
  message,
}) {
  const height = 96;

  const accessibleText = createAccessibleText(message);

  message = message.toUpperCase();

  const { metrics, svg } = renderMessagePath(message, { x: 40, y: 46.8, fontSize: 33.5, letterSpacing: .02, anchor: 'left middle', attributes: { fill: "red" } });

  return renderBadge(
    {
      width: Math.round(metrics.width + 40 + 173),
      accessibleText,
      height,
    },
    svg
  );
}

function renderMessagePath(message, options) {
  const textToSVG = TextToSVG.loadSync('build-scripts/fonts/Figtree-Bold.otf');
  const svg = textToSVG.getPath(message, options);
  const metrics = textToSVG.getMetrics(message, options);
  return { metrics, svg };
}

if (!fs.existsSync(OUTPUT_DIR)) {
  fs.mkdirSync(OUTPUT_DIR, { recursive: true });
}

function writeBadge(filename, message) {
  const badge = myBadge({
    message,
  });
  fs.writeFileSync(
    path.resolve(OUTPUT_DIR, `${filename}.svg`),
    optimize(badge).data
  );
}

redirects.forEach((redirect) =>
  writeBadge(redirect.redirect, redirect.badge || redirect.name)
);

// writeBadge("homeassistant", "Home Assistant");
